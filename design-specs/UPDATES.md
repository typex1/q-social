# Q-Social Design Document Updates - Summary

## Changes Made (2026-02-27)

### Critical Fixes

1. **DynamoDB GSI Removed**
   - Removed Global Secondary Index with createdAt as partition key
   - Using simple Scan operation with in-memory sorting instead
   - Rationale: Timestamp-based partition keys create hot partitions and poor distribution
   - Note added for production scaling considerations

2. **Project Structure Clarified**
   - Added explicit directory structure diagram (Section 2.1)
   - Clarified Next.js App Router structure: `app/` instead of `frontend/`
   - Fixed import paths throughout to match actual structure

3. **Shared Validation Integration**
   - Backend implementations now import and use `validateMessageContent()` from shared code
   - Removed duplicate validation logic
   - Consistent error handling across local and AWS modes

4. **CORS Configuration Fixed**
   - Added `CORS_ORIGIN` environment variable to Lambda functions in CDK
   - Set to CloudFront distribution domain (not wildcard)
   - Updated API Gateway CORS to use specific origin
   - Added `CORS_ORIGINS` environment variable for local Express server

5. **Deployment Process Corrected**
   - Fixed deployment order: Backend → Infrastructure → Frontend build → S3 upload
   - S3 bucket and CloudFront created before Lambda functions (needed for CORS_ORIGIN)
   - Frontend deployment script now uploads to S3 and invalidates CloudFront cache
   - Added BucketName to CDK outputs
   - Removed CDK S3 deployment construct (using AWS CLI instead)

6. **Next.js Configuration Updated**
   - Added `output: 'export'` for static site generation
   - Added `images.unoptimized: true` for static export compatibility
   - Proxy rewrites only active in development mode
   - Simplified configuration

7. **Environment Variables Standardized**
   - Removed unused `NEXT_PUBLIC_APP_URL`
   - Frontend uses `NEXT_PUBLIC_API_URL` directly (no config manager needed)
   - Added `.env.production.local` (generated by deploy script)
   - Added `CORS_ORIGINS` for local backend

8. **Dependencies Added**
   - Added `tsx` to dev dependencies (for running TypeScript in development)
   - Added `@types/express` and `@types/cors` to dev dependencies
   - Documented in Technology Stack section

### Minor Improvements

9. **Sanitization Simplified**
   - Removed HTML tag removal (React auto-escapes content)
   - Added note explaining XSS protection is handled by React
   - Kept function for consistency but simplified implementation

10. **Error Logging Standardized**
    - All backend error handling uses `logError()` utility
    - Consistent structured logging format

11. **CDK Asset Path Fixed**
    - Changed from `'backend/aws/dist'` to `'../backend/aws/dist'`
    - Correct relative path from infrastructure/ directory

### Tasks Document Updates

- Updated Phase 1 to include tsx installation and correct directory structure
- Removed separate database init file (consolidated in server.ts)
- Updated all import paths to match app/ structure
- Removed sanitization utility task
- Added CORS environment variable configuration
- Reordered Phase 5 tasks to create S3/CloudFront before Lambda
- Updated Phase 6 with correct deployment workflow
- Removed CDK S3 deployment tasks (using AWS CLI instead)
- Added CloudFront cache invalidation step

## Files Modified

1. `design-specs/design.md` - 11 sections updated
2. `design-specs/tasks.md` - 15 task groups updated

## Validation Checklist

- [x] All import paths consistent with project structure
- [x] DynamoDB design suitable for small-scale application
- [x] CORS configuration secure and functional
- [x] Deployment order prevents circular dependencies
- [x] Environment variables properly documented
- [x] Shared code properly utilized
- [x] All critical issues addressed
- [x] Tasks align with updated design

## Notes for Implementation

- The DynamoDB Scan approach is acceptable for small datasets (< 1000 messages)
- For production scale, consider pagination or time-based partitioning
- CloudFront distribution ID extraction in deploy script is simplified (may need adjustment)
- AWS CLI must be installed and configured for deployment script to work
- React's automatic XSS protection is sufficient for plain text content
